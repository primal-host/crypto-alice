<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Koi</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #0f1117;
  color: #e4e4e7;
  min-height: 100vh;
}
header {
  padding: 1.25rem 2rem;
  background: #16181d;
  border-bottom: 1px solid #27272a;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
header h1 { font-size: 1.5rem; font-weight: 700; color: #f59e0b; }
header .info { color: #71717a; font-size: 0.8rem; }
main {
  max-width: 80rem;
  margin: 0 auto;
  padding: 1.5rem;
}
.koi-card {
  background: #16181d;
  border: 1px solid #27272a;
  border-radius: 0.5rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  text-align: center;
  position: relative;
}
.depletion {
  position: absolute;
  top: 1rem;
  right: 1.25rem;
  color: #52525b;
  font-size: 0.8rem;
  font-variant-numeric: tabular-nums;
}
.koi-balance {
  font-size: 2rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  word-break: break-all;
}
.wallets {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}
.wallet-card {
  background: #16181d;
  border: 1px solid #27272a;
  border-radius: 0.5rem;
  padding: 1.25rem;
}
.wallet-card .name {
  font-size: 0.8rem;
  color: #71717a;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.75rem;
}
.acct-row {
  display: flex;
  justify-content: space-between;
  font-size: 0.8rem;
  padding: 0.15rem 0;
  font-variant-numeric: tabular-nums;
}
.acct-row .label { color: #71717a; }
.acct-row .value { text-align: right; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; }
.acct-row.vested .value { color: #f59e0b; }
.acct-row.available .value { color: #fb923c; }
.acct-row.interest .value { color: #4ade80; }
.acct-row.sent .value { color: #f87171; }
.acct-row.balance-row {
  font-weight: 700;
  padding: 0.5rem 0 0.25rem;
  border-top: 1px solid #27272a;
  margin-top: 0.35rem;
}
.acct-row.balance-row .label { color: #a1a1aa; }
.wallet-card .rate {
  font-size: 0.8rem;
  color: #4ade80;
  font-variant-numeric: tabular-nums;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  margin-bottom: 0.35rem;
}
.acct-row.sent {
  border-top: 1px solid #27272a;
  margin-top: 0.35rem;
  padding-top: 0.35rem;
}
.section {
  background: #16181d;
  border: 1px solid #27272a;
  border-radius: 0.5rem;
  padding: 1.25rem;
  margin-bottom: 1rem;
}
.section h2 {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: #a1a1aa;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.transfer-form {
  display: flex;
  gap: 0.75rem;
  align-items: end;
  flex-wrap: wrap;
}
.field {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}
.field label {
  font-size: 0.7rem;
  color: #71717a;
  text-transform: uppercase;
}
.field select, .field input {
  padding: 0.5rem 0.75rem;
  background: #0f1117;
  border: 1px solid #27272a;
  border-radius: 0.25rem;
  color: #e4e4e7;
  font-size: 0.875rem;
}
.field select:focus, .field input:focus {
  outline: none;
  border-color: #f59e0b;
}
.btn {
  padding: 0.5rem 1.25rem;
  background: #f59e0b;
  color: #0f1117;
  border: none;
  border-radius: 0.25rem;
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
}
.btn:hover { background: #d97706; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.error-msg {
  color: #f87171;
  font-size: 0.8rem;
  margin-top: 0.5rem;
}
.log-entries {
  max-height: 16rem;
  overflow-y: auto;
}
.log-entry {
  padding: 0.4rem 0;
  border-bottom: 1px solid #1e1e24;
  font-size: 0.8rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.log-entry:last-child { border-bottom: none; }
.log-entry .detail { color: #a1a1aa; }
.log-entry .detail .amount { color: #e4e4e7; font-weight: 600; }
.log-entry .detail .arrow { color: #71717a; }
.log-entry .detail .fee { color: #71717a; font-size: 0.7rem; margin-left: 0.5rem; }
.log-entry .time { color: #71717a; font-size: 0.7rem; white-space: nowrap; margin-left: 1rem; }
.status {
  font-size: 0.7rem;
  padding: 0.15rem 0.5rem;
  border-radius: 0.25rem;
}
.status.ok { background: #14532d; color: #4ade80; }
.status.err { background: #451a03; color: #fb923c; }
.halvings-table {
  max-height: 20rem;
  overflow-y: auto;
}
.halvings-table table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
  font-variant-numeric: tabular-nums;
}
.halvings-table th {
  text-align: left;
  color: #71717a;
  font-weight: 600;
  padding: 0.25rem 0.5rem;
  border-bottom: 1px solid #27272a;
  position: sticky;
  top: 0;
  background: #16181d;
}
.halvings-table td {
  padding: 0.15rem 0.5rem;
  border-bottom: 1px solid #1e1e24;
}
.halvings-table .num { color: #71717a; }
.halvings-table .mono { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; }
.halvings-table .apr { color: #4ade80; }
.halvings-table tr.done { opacity: 0.4; }
.halvings-table tr.current td { color: #f59e0b; }
.halvings-table tr.current .num { color: #f59e0b; }
.halvings-table tr.current .apr { color: #f59e0b; }
</style>
</head>
<body>
<header>
  <h1>Koi</h1>
  <div>
    <span class="info" id="apr-info">APR: --</span>
    <span id="ws-status" class="status err" style="margin-left:0.75rem">disconnected</span>
  </div>
</header>
<main>
  <div class="koi-card">
    <div class="koi-balance" id="koi-bal"></div>
    <span class="depletion" id="depletion"></span>
  </div>

  <div class="section">
    <h2>Transfer</h2>
    <div class="transfer-form">
      <div class="field">
        <label>From</label>
        <select id="sel-from"></select>
      </div>
      <div class="field">
        <label>To</label>
        <select id="sel-to"></select>
      </div>
      <div class="field">
        <label>Amount</label>
        <input type="number" id="inp-amount" min="0" step="any" placeholder="0.00">
      </div>
      <button class="btn" id="btn-send">Send</button>
    </div>
    <div id="error" class="error-msg"></div>
  </div>

  <div class="wallets" id="wallets"></div>

  <div class="section">
    <h2>Transaction Log</h2>
    <div class="log-entries" id="log"></div>
  </div>

  <div class="section" id="halvings-section" style="display:none">
    <h2>Halving Schedule</h2>
    <div class="halvings-table" id="halvings"></div>
  </div>
</main>

<script>
var state = null;
var tOff = 0;
var balHistory = {};
var LOOKBACK = 10;

function sNow() { return Date.now() / 1000 + tOff; }

function fmt(n) {
  var a = Math.abs(n);
  var s = n < 0 ? '-' : '\u00a0';
  var v, u;
  if (a >= 1e9)       { v = a / 1e9;  u = 'gKoi'; }
  else if (a >= 1e6)  { v = a / 1e6;  u = 'eKoi'; }
  else if (a >= 1e3)  { v = a / 1e3;  u = 'kKoi'; }
  else if (a >= 1)    { v = a;         u = '\u00a0Koi'; }
  else if (a >= 1e-3) { v = a * 1e3;  u = 'mKoi'; }
  else if (a >= 1e-6) { v = a * 1e6;  u = 'uKoi'; }
  else                { v = a * 1e9;  u = 'nKoi'; }
  var d = v >= 100 ? 1 : v >= 10 ? 2 : 3;
  var p = Math.pow(10, d);
  var f = (Math.floor(v * p) / p).toFixed(d);
  var lead = v >= 100 ? '' : v >= 10 ? '\u00a0' : '\u00a0\u00a0';
  var trail = d === 1 ? '\u00a0\u00a0' : d === 2 ? '\u00a0' : '';
  return s + lead + f + trail + ' ' + u;
}

function calcAccounts(w, t) {
  if (w.name === 'Koi') {
    return { locked: 0, vested: 0, available: 0, total: w.balance, interest: 0, sent: w.sent };
  }
  var dt = (t - w.t) / state.spy;
  var erate = state.rate * state.wallets[0].balance / state.supply;
  var vested = Math.min(w.locked, w.locked * (Math.exp(state.prate * dt) - 1));
  var totalPending = w.vested + vested;
  var interest = (w.balance + totalPending) * (Math.exp(erate * dt) - 1);
  return {
    locked: w.locked + w.vested,
    vested: totalPending,
    available: 3 * (w.locked - vested) / 4,
    total: w.balance + interest + totalPending,
    interest: w.interest + interest,
    sent: w.sent
  };
}

function calcKoiBal(t) {
  var bal = state.wallets[0].balance;
  var erate = state.rate * bal / state.supply;
  for (var i = 1; i < state.wallets.length; i++) {
    var o = state.wallets[i];
    var dt = (t - o.t) / state.spy;
    var vested = Math.min(o.locked, o.locked * (Math.exp(state.prate * dt) - 1));
    var totalPending = o.vested + vested;
    bal -= (o.balance + totalPending) * (Math.exp(erate * dt) - 1);
  }
  return bal;
}



function initCards() {
  var c = document.getElementById('wallets');
  c.innerHTML = '';
  var sf = document.getElementById('sel-from');
  var st = document.getElementById('sel-to');
  sf.innerHTML = '';
  st.innerHTML = '';
  var show = { Alice: 1, Bob: 1, Carol: 1, Millionaire: 1 };
  for (var i = 0; i < state.wallets.length && i < 7; i++) {
    var w = state.wallets[i];
    if (show[w.name]) {
      var card = document.createElement('div');
      card.className = 'wallet-card';
      card.id = 'card-' + w.name;
      if (w.contract) {
        card.innerHTML =
          '<div class="name">' + w.name + ' <span style="color:#f59e0b;font-size:0.65rem">CONTRACT</span></div>' +
          '<div class="acct-row balance-row"><span class="label">Balance</span><span class="value" id="bal-' + w.name + '"></span></div>' +
          '<div class="rate" id="rate-' + w.name + '"></div>';
      } else {
        card.innerHTML =
          '<div class="name">' + w.name + '</div>' +
          '<div class="acct-row interest"><span class="label">Interest</span><span class="value" id="int-' + w.name + '"></span></div>' +
          '<div class="acct-row vested"><span class="label">Vested</span><span class="value" id="pnd-' + w.name + '"></span></div>' +
          '<div class="acct-row"><span class="label">Locked</span><span class="value" id="dep-' + w.name + '"></span></div>' +
          '<div class="acct-row available"><span class="label">Available</span><span class="value" id="imm-' + w.name + '"></span></div>' +
          '<div class="acct-row balance-row"><span class="label">Balance</span><span class="value" id="bal-' + w.name + '"></span></div>';
      }
      c.appendChild(card);
    }
    sf.add(new Option(w.name, w.name));
    st.add(new Option(w.name, w.name));
  }
  st.selectedIndex = 1;
}

function render() {
  if (!state) return;
  var t = sNow();

  // Koi banner
  var koiBal = calcKoiBal(t);
  var whole = Math.floor(koiBal);
  document.getElementById('koi-bal').textContent = whole.toLocaleString('en-US') + ' Koi';

  // Depletion estimate
  var drainPerSec = koiBal - calcKoiBal(t + 1);
  if (drainPerSec > 0) {
    var weeks = Math.floor(koiBal / (drainPerSec * 604800));
    document.getElementById('depletion').textContent = '' + weeks;
  } else {
    document.getElementById('depletion').textContent = '';
  }

  // Effective APR
  var effectiveAPR = state.rate * Math.max(0, koiBal) / state.supply * 100;
  document.getElementById('apr-info').textContent = 'APR: ' + effectiveAPR.toFixed(2) + '%';

  // Halving schedule
  updateHalvings(koiBal);

  // All wallets
  for (var i = 0; i < state.wallets.length; i++) {
    var w = state.wallets[i];
    var balEl = document.getElementById('bal-' + w.name);
    if (!balEl) continue;
    if (w.name === 'Koi') {
      balEl.textContent = fmt(koiBal);
    } else if (w.contract) {
      balEl.textContent = fmt(w.balance);
      var rateEl = document.getElementById('rate-' + w.name);
      var hist = balHistory[w.name];
      if (hist && hist.length > 1) {
        var first = hist[0], last = hist[hist.length - 1];
        var dt = last.t - first.t;
        if (dt > 0) {
          var r = (last.b - first.b) / dt;
          rateEl.textContent = (r >= 0 ? '+' : '') + fmt(r) + '/sec';
        }
      }
    } else {
      var a = calcAccounts(w, t);
      document.getElementById('dep-' + w.name).textContent = fmt(a.locked);
      document.getElementById('pnd-' + w.name).textContent = fmt(a.vested);
      document.getElementById('imm-' + w.name).textContent = fmt(a.available);
      balEl.textContent = fmt(a.total);
      document.getElementById('int-' + w.name).textContent = fmt(a.interest);
      document.getElementById('snt-' + w.name).textContent = fmt(a.sent);
    }
  }
}

function renderLog() {
  if (!state) return;
  var c = document.getElementById('log');
  c.innerHTML = '';
  var entries = state.log.slice(-10).reverse();
  for (var i = 0; i < entries.length; i++) {
    var e = entries[i];
    var d = document.createElement('div');
    d.className = 'log-entry';
    var feeHtml = e.fee > 0 ? ' <span class="fee">(fee ' + fmt(e.fee) + ')</span>' : '';
    d.innerHTML =
      '<span class="detail">' + e.from + ' <span class="arrow">\u2192</span> ' +
      e.to + ': <span class="amount">' + fmt(e.amount) + '</span>' + feeHtml + '</span>' +
      '<span class="time">' + fmtAgo(e.t) + '</span>';
    c.appendChild(d);
  }
}

function fmtAgo(t) {
  var s = sNow() - t;
  if (s < 60) return Math.floor(s) + 's ago';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  return Math.floor(s / 86400) + 'd ago';
}

document.getElementById('btn-send').addEventListener('click', async function() {
  var from = document.getElementById('sel-from').value;
  var to = document.getElementById('sel-to').value;
  var amount = parseFloat(document.getElementById('inp-amount').value);
  var errEl = document.getElementById('error');
  errEl.textContent = '';

  if (from === to) {
    amount = amount || 0;
    if (amount < 0) { errEl.textContent = 'Enter a valid amount'; return; }
  } else {
    if (!amount || amount <= 0) { errEl.textContent = 'Enter a valid amount'; return; }
  }

  this.disabled = true;
  try {
    var res = await fetch('/api/send', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({from: from, to: to, amount: amount}),
    });
    var data = await res.json();
    if (!data.ok) {
      errEl.textContent = data.error || 'Transfer failed';
    } else {
      document.getElementById('inp-amount').value = '';
    }
  } catch (e) {
    errEl.textContent = 'Network error';
  }
  this.disabled = false;
});

function fmtAPR(v) {
  if (v >= 10) return v.toFixed(1) + '%';
  if (v >= 0.01) return v.toFixed(2) + '%';
  return v.toExponential(1) + '%';
}

var halvingsBuilt = false;
var halvingsData = [];

function buildHalvings() {
  var N = state.supply;
  var K0 = state.k0;
  var S0 = N - K0;
  var R = state.rate;
  var maxN = Math.floor(Math.log(K0 / 1e-9) / Math.log(2));
  var maxT = Math.log((N * Math.pow(2, maxN) - K0) / S0) / R;
  halvingsData = [];
  var html = '<table><thead><tr><th class="num">#</th><th style="width:25%"></th><th>Years</th><th>Balance</th><th>APR</th></tr></thead><tbody>';
  for (var n = 1; n <= maxN; n++) {
    var K = K0 / Math.pow(2, n);
    var t = Math.log((N * Math.pow(2, n) - K0) / S0) / R;
    var apr = K / N * R * 100;
    var pct = (t / maxT * 100).toFixed(1);
    halvingsData.push({ n: n, threshold: K, years: t, apr: apr });
    html += '<tr id="halv-' + n + '">';
    html += '<td class="num">' + n + '</td>';
    html += '<td><div style="background:linear-gradient(to right,#f59e0b,#f97316);height:0.4rem;width:' + pct + '%;border-radius:2px"></div></td>';
    html += '<td id="halv-yr-' + n + '">' + t.toFixed(1) + '</td>';
    html += '<td class="mono" id="halv-bal-' + n + '">' + fmt(K) + '</td>';
    html += '<td class="apr">' + fmtAPR(apr) + '</td>';
    html += '</tr>';
  }
  html += '</tbody></table>';
  document.getElementById('halvings').innerHTML = html;
  document.getElementById('halvings-section').style.display = '';
  halvingsBuilt = true;
}

function updateHalvings(koiBal) {
  if (!halvingsBuilt) return;
  for (var i = 0; i < halvingsData.length; i++) {
    var h = halvingsData[i];
    var row = document.getElementById('halv-' + h.n);
    if (!row) continue;
    if (koiBal <= h.threshold) {
      row.className = 'done';
    } else if (i === 0 || koiBal <= halvingsData[i - 1].threshold) {
      row.className = 'current';
    } else {
      row.className = '';
    }
  }
}

var cardsInit = false;

function connect() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  var ws = new WebSocket(proto + '//' + location.host + '/ws');
  var st = document.getElementById('ws-status');

  ws.onopen = function() {
    st.textContent = 'connected';
    st.className = 'status ok';
  };

  ws.onmessage = function(e) {
    var prev = state;
    state = JSON.parse(e.data);
    tOff = state.t - Date.now() / 1000;
    if (!cardsInit) { initCards(); buildHalvings(); cardsInit = true; }
    // Track contract balance history for smoothed deposit rate
    for (var i = 0; i < state.wallets.length; i++) {
      var w = state.wallets[i];
      if (w.contract) {
        if (!balHistory[w.name]) balHistory[w.name] = [];
        balHistory[w.name].push({ t: state.t, b: w.balance });
        // Trim samples older than lookback window
        var cutoff = state.t - LOOKBACK;
        while (balHistory[w.name].length > 1 && balHistory[w.name][0].t < cutoff) {
          balHistory[w.name].shift();
        }
      }
    }
    renderLog();
  };

  ws.onclose = function() {
    st.textContent = 'disconnected';
    st.className = 'status err';
    cardsInit = false;
    setTimeout(connect, 1000);
  };

  ws.onerror = function() { ws.close(); };
}

connect();
setInterval(render, 1000);
setInterval(renderLog, 5000);
</script>
</body>
</html>
