<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Koi</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #0f1117;
  color: #e4e4e7;
  min-height: 100vh;
}
header {
  padding: 1.25rem 2rem;
  background: #16181d;
  border-bottom: 1px solid #27272a;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
header h1 { font-size: 1.5rem; font-weight: 700; color: #f59e0b; }
header .info { color: #71717a; font-size: 0.8rem; }
main {
  max-width: 80rem;
  margin: 0 auto;
  padding: 1.5rem;
}
.koi-card {
  background: #16181d;
  border: 1px solid #27272a;
  border-radius: 0.5rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  text-align: center;
}
.koi-balance {
  font-size: 2rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  word-break: break-all;
}
.koi-rate {
  font-size: 0.8rem;
  color: #f87171;
  margin-top: 0.25rem;
  font-variant-numeric: tabular-nums;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
}
.wallets {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}
.wallet-card {
  background: #16181d;
  border: 1px solid #27272a;
  border-radius: 0.5rem;
  padding: 1.25rem;
}
.wallet-card .name {
  font-size: 0.8rem;
  color: #71717a;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.75rem;
}
.acct-row {
  display: flex;
  justify-content: space-between;
  font-size: 0.8rem;
  padding: 0.15rem 0;
  font-variant-numeric: tabular-nums;
}
.acct-row .label { color: #71717a; }
.acct-row .value { text-align: right; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; }
.acct-row.pending .value { color: #f59e0b; }
.acct-row.available .value { color: #fb923c; }
.acct-row.interest .value { color: #4ade80; }
.acct-row.sent .value { color: #f87171; }
.acct-row.balance-row {
  font-weight: 700;
  padding: 0.5rem 0 0.25rem;
  border-top: 1px solid #27272a;
  margin-top: 0.35rem;
}
.acct-row.balance-row .label { color: #a1a1aa; }
.wallet-card .rate {
  font-size: 0.8rem;
  color: #4ade80;
  font-variant-numeric: tabular-nums;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  margin-bottom: 0.35rem;
}
.acct-row.sent {
  border-top: 1px solid #27272a;
  margin-top: 0.35rem;
  padding-top: 0.35rem;
}
.section {
  background: #16181d;
  border: 1px solid #27272a;
  border-radius: 0.5rem;
  padding: 1.25rem;
  margin-bottom: 1rem;
}
.section h2 {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: #a1a1aa;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.transfer-form {
  display: flex;
  gap: 0.75rem;
  align-items: end;
  flex-wrap: wrap;
}
.field {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}
.field label {
  font-size: 0.7rem;
  color: #71717a;
  text-transform: uppercase;
}
.field select, .field input {
  padding: 0.5rem 0.75rem;
  background: #0f1117;
  border: 1px solid #27272a;
  border-radius: 0.25rem;
  color: #e4e4e7;
  font-size: 0.875rem;
}
.field select:focus, .field input:focus {
  outline: none;
  border-color: #f59e0b;
}
.btn {
  padding: 0.5rem 1.25rem;
  background: #f59e0b;
  color: #0f1117;
  border: none;
  border-radius: 0.25rem;
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
}
.btn:hover { background: #d97706; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.error-msg {
  color: #f87171;
  font-size: 0.8rem;
  margin-top: 0.5rem;
}
.log-entries {
  max-height: 16rem;
  overflow-y: auto;
}
.log-entry {
  padding: 0.4rem 0;
  border-bottom: 1px solid #1e1e24;
  font-size: 0.8rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.log-entry:last-child { border-bottom: none; }
.log-entry .detail { color: #a1a1aa; }
.log-entry .detail .amount { color: #e4e4e7; font-weight: 600; }
.log-entry .detail .arrow { color: #71717a; }
.log-entry .time { color: #71717a; font-size: 0.7rem; white-space: nowrap; margin-left: 1rem; }
.status {
  font-size: 0.7rem;
  padding: 0.15rem 0.5rem;
  border-radius: 0.25rem;
}
.status.ok { background: #14532d; color: #4ade80; }
.status.err { background: #451a03; color: #fb923c; }
</style>
</head>
<body>
<header>
  <h1>Koi</h1>
  <div>
    <span class="info">APR: ln(4/3) &#8776; 28.77%</span>
    <span id="ws-status" class="status err" style="margin-left:0.75rem">disconnected</span>
  </div>
</header>
<main>
  <div class="koi-card">
    <div class="koi-balance" id="koi-bal"></div>
    <div class="koi-rate" id="koi-rate"></div>
  </div>

  <div class="wallets" id="wallets"></div>

  <div class="section">
    <h2>Transfer</h2>
    <div class="transfer-form">
      <div class="field">
        <label>From</label>
        <select id="sel-from"></select>
      </div>
      <div class="field">
        <label>To</label>
        <select id="sel-to"></select>
      </div>
      <div class="field">
        <label>Amount</label>
        <input type="number" id="inp-amount" min="0" step="any" placeholder="0.00">
      </div>
      <button class="btn" id="btn-send">Send</button>
    </div>
    <div id="error" class="error-msg"></div>
  </div>

  <div class="section">
    <h2>Transaction Log</h2>
    <div class="log-entries" id="log"></div>
  </div>
</main>

<script>
var state = null;
var tOff = 0;

function sNow() { return Date.now() / 1000 + tOff; }

function fmt(n) {
  var a = Math.abs(n);
  var s = n < 0 ? '-' : '\u00a0';
  var v, u;
  if (a >= 1e9)       { v = a / 1e9;  u = 'gKoi'; }
  else if (a >= 1e6)  { v = a / 1e6;  u = 'eKoi'; }
  else if (a >= 1e3)  { v = a / 1e3;  u = 'kKoi'; }
  else if (a >= 1e-3) { v = a;         u = '\u00a0Koi'; }
  else if (a >= 1e-6) { v = a * 1e3;  u = 'mKoi'; }
  else if (a >= 1e-9) { v = a * 1e6;  u = 'uKoi'; }
  else                { v = a * 1e9;  u = 'nKoi'; }
  var f = (Math.floor(v * 1000) / 1000).toFixed(3);
  while (f.length < 7) f = '\u00a0' + f;
  return s + f + ' ' + u;
}

function calcAccounts(w, t) {
  if (w.name === 'Koi') {
    return { deposits: 0, pending: 0, available: 0, interest: 0, total: w.balance, sent: w.sent };
  }
  var dt = (t - w.t) / state.spy;
  var pending = Math.min(w.deposits, w.deposits * (Math.exp(state.prate * dt) - 1));
  var interest = (w.balance + pending) * (Math.exp(state.rate * dt) - 1);
  return {
    deposits: w.deposits,
    pending: pending,
    available: 3 * (w.deposits - pending) / 4,
    interest: interest,
    total: w.balance + pending + interest,
    sent: w.sent
  };
}

function calcKoiBal(t) {
  var bal = state.wallets[0].balance;
  for (var i = 1; i < state.wallets.length; i++) {
    var o = state.wallets[i];
    var dt = (t - o.t) / state.spy;
    var pnd = Math.min(o.deposits, o.deposits * (Math.exp(state.prate * dt) - 1));
    bal -= pnd;
    bal -= (o.balance + pnd) * (Math.exp(state.rate * dt) - 1);
  }
  return bal;
}

function calcRate(w, t) {
  if (w.name === 'Koi') return 0;
  var dt = (t - w.t) / state.spy;
  var irps = state.rate / state.spy;
  var prps = state.prate / state.spy;
  var pending = Math.min(w.deposits, w.deposits * (Math.exp(state.prate * dt) - 1));
  var rate = (w.balance + pending) * irps * Math.exp(state.rate * dt);
  if (w.deposits * (Math.exp(state.prate * dt) - 1) < w.deposits) {
    rate += w.deposits * prps * Math.exp(state.prate * dt);
  }
  return rate;
}

function initCards() {
  var c = document.getElementById('wallets');
  c.innerHTML = '';
  var sf = document.getElementById('sel-from');
  var st = document.getElementById('sel-to');
  sf.innerHTML = '';
  st.innerHTML = '';
  for (var i = 0; i < state.wallets.length; i++) {
    var w = state.wallets[i];
    var card = document.createElement('div');
    card.className = 'wallet-card';
    card.id = 'card-' + w.name;
    if (w.name === 'Koi') {
      card.innerHTML =
        '<div class="name">' + w.name + '</div>' +
        '<div class="acct-row balance-row"><span class="label">Balance</span><span class="value" id="bal-' + w.name + '"></span></div>';
    } else {
      card.innerHTML =
        '<div class="name">' + w.name + '</div>' +
        '<div class="acct-row"><span class="label">Deposits</span><span class="value" id="dep-' + w.name + '"></span></div>' +
        '<div class="acct-row pending"><span class="label">Pending</span><span class="value" id="pnd-' + w.name + '"></span></div>' +
        '<div class="acct-row available"><span class="label">Available</span><span class="value" id="imm-' + w.name + '"></span></div>' +
        '<div class="acct-row interest"><span class="label">Interest</span><span class="value" id="int-' + w.name + '"></span></div>' +
        '<div class="acct-row balance-row"><span class="label">Balance</span><span class="value" id="bal-' + w.name + '"></span></div>' +
        '<div class="rate" id="rate-' + w.name + '"></div>' +
        '<div class="acct-row sent"><span class="label">Sent</span><span class="value" id="snt-' + w.name + '"></span></div>';
    }
    c.appendChild(card);
    sf.add(new Option(w.name, w.name));
    st.add(new Option(w.name, w.name));
  }
  st.selectedIndex = 1;
}

function render() {
  if (!state) return;
  var t = sNow();

  // Koi banner
  var koiBal = calcKoiBal(t);
  document.getElementById('koi-bal').textContent = fmt(koiBal);
  var drain = 0;
  for (var i = 1; i < state.wallets.length; i++) {
    drain += calcRate(state.wallets[i], t);
  }
  document.getElementById('koi-rate').textContent = '-' + fmt(drain) + '/sec';

  // All wallets
  for (var i = 0; i < state.wallets.length; i++) {
    var w = state.wallets[i];
    var a = calcAccounts(w, t);
    var rate = calcRate(w, t);
    var balEl = document.getElementById('bal-' + w.name);
    if (!balEl) continue;
    if (w.name !== 'Koi') {
      document.getElementById('dep-' + w.name).textContent = fmt(a.deposits);
      document.getElementById('pnd-' + w.name).textContent = fmt(a.pending);
      document.getElementById('imm-' + w.name).textContent = fmt(a.available);
      document.getElementById('int-' + w.name).textContent = fmt(a.interest);
    }
    balEl.textContent = fmt(a.total);
    if (w.name !== 'Koi') {
      document.getElementById('rate-' + w.name).textContent = '+' + fmt(rate) + '/sec';
      document.getElementById('snt-' + w.name).textContent = fmt(a.sent);
    }
  }
}

function renderLog() {
  if (!state) return;
  var c = document.getElementById('log');
  c.innerHTML = '';
  var entries = state.log.slice().reverse();
  for (var i = 0; i < entries.length; i++) {
    var e = entries[i];
    var d = document.createElement('div');
    d.className = 'log-entry';
    d.innerHTML =
      '<span class="detail">' + e.from + ' <span class="arrow">\u2192</span> ' +
      e.to + ': <span class="amount">' + fmt(e.amount) + '</span></span>' +
      '<span class="time">' + fmtAgo(e.t) + '</span>';
    c.appendChild(d);
  }
}

function fmtAgo(t) {
  var s = sNow() - t;
  if (s < 60) return Math.floor(s) + 's ago';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  return Math.floor(s / 86400) + 'd ago';
}

document.getElementById('btn-send').addEventListener('click', async function() {
  var from = document.getElementById('sel-from').value;
  var to = document.getElementById('sel-to').value;
  var amount = parseFloat(document.getElementById('inp-amount').value);
  var errEl = document.getElementById('error');
  errEl.textContent = '';

  if (!amount || amount <= 0) { errEl.textContent = 'Enter a valid amount'; return; }

  this.disabled = true;
  try {
    var res = await fetch('/api/send', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({from: from, to: to, amount: amount}),
    });
    var data = await res.json();
    if (!data.ok) {
      errEl.textContent = data.error || 'Transfer failed';
    } else {
      document.getElementById('inp-amount').value = '';
    }
  } catch (e) {
    errEl.textContent = 'Network error';
  }
  this.disabled = false;
});

var cardsInit = false;

function connect() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  var ws = new WebSocket(proto + '//' + location.host + '/ws');
  var st = document.getElementById('ws-status');

  ws.onopen = function() {
    st.textContent = 'connected';
    st.className = 'status ok';
  };

  ws.onmessage = function(e) {
    state = JSON.parse(e.data);
    tOff = state.t - Date.now() / 1000;
    if (!cardsInit) { initCards(); cardsInit = true; }
    renderLog();
  };

  ws.onclose = function() {
    st.textContent = 'disconnected';
    st.className = 'status err';
    cardsInit = false;
    setTimeout(connect, 1000);
  };

  ws.onerror = function() { ws.close(); };
}

connect();
setInterval(render, 1000);
setInterval(renderLog, 5000);
</script>
</body>
</html>
