<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Koi</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #0f1117;
  color: #e4e4e7;
  min-height: 100vh;
}
header {
  padding: 1.25rem 2rem;
  background: #16181d;
  border-bottom: 1px solid #27272a;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
header h1 { font-size: 1.5rem; font-weight: 700; color: #f59e0b; }
header .info { color: #71717a; font-size: 0.8rem; }
main {
  max-width: 80rem;
  margin: 0 auto;
  padding: 1.5rem;
}
.koi-card {
  background: #16181d;
  border: 1px solid #27272a;
  border-radius: 0.5rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  text-align: center;
}
.koi-balance {
  font-size: 2rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  word-break: break-all;
}
.koi-rate {
  font-size: 0.75rem;
  color: #f87171;
  margin-top: 0.25rem;
  font-variant-numeric: tabular-nums;
}
.wallets {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(14rem, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}
.wallet-card {
  background: #16181d;
  border: 1px solid #27272a;
  border-radius: 0.5rem;
  padding: 1.25rem;
}
.wallet-card .name {
  font-size: 0.8rem;
  color: #71717a;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.5rem;
}
.wallet-card .balance {
  font-size: 1.25rem;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  word-break: break-all;
}
.wallet-card .rate {
  font-size: 0.75rem;
  color: #4ade80;
  margin-top: 0.25rem;
  font-variant-numeric: tabular-nums;
}
.wallet-card .pending-label {
  font-size: 0.7rem;
  color: #71717a;
  text-transform: uppercase;
  margin-top: 0.75rem;
  margin-bottom: 0.25rem;
}
.wallet-card .pending-item {
  font-size: 0.8rem;
  color: #f59e0b;
  font-variant-numeric: tabular-nums;
  padding: 0.1rem 0;
}
.section {
  background: #16181d;
  border: 1px solid #27272a;
  border-radius: 0.5rem;
  padding: 1.25rem;
  margin-bottom: 1rem;
}
.section h2 {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: #a1a1aa;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.transfer-form {
  display: flex;
  gap: 0.75rem;
  align-items: end;
  flex-wrap: wrap;
}
.field {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}
.field label {
  font-size: 0.7rem;
  color: #71717a;
  text-transform: uppercase;
}
.field select, .field input {
  padding: 0.5rem 0.75rem;
  background: #0f1117;
  border: 1px solid #27272a;
  border-radius: 0.25rem;
  color: #e4e4e7;
  font-size: 0.875rem;
}
.field select:focus, .field input:focus {
  outline: none;
  border-color: #f59e0b;
}
.btn {
  padding: 0.5rem 1.25rem;
  background: #f59e0b;
  color: #0f1117;
  border: none;
  border-radius: 0.25rem;
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
}
.btn:hover { background: #d97706; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.error-msg {
  color: #f87171;
  font-size: 0.8rem;
  margin-top: 0.5rem;
}
.log-entries {
  max-height: 16rem;
  overflow-y: auto;
}
.log-entry {
  padding: 0.4rem 0;
  border-bottom: 1px solid #1e1e24;
  font-size: 0.8rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.log-entry:last-child { border-bottom: none; }
.log-entry .detail { color: #a1a1aa; }
.log-entry .detail .amount { color: #e4e4e7; font-weight: 600; }
.log-entry .detail .arrow { color: #71717a; }
.log-entry .time { color: #71717a; font-size: 0.7rem; white-space: nowrap; margin-left: 1rem; }
.status {
  font-size: 0.7rem;
  padding: 0.15rem 0.5rem;
  border-radius: 0.25rem;
}
.status.ok { background: #14532d; color: #4ade80; }
.status.err { background: #451a03; color: #fb923c; }
</style>
</head>
<body>
<header>
  <h1>Koi</h1>
  <div>
    <span class="info">APR: ln(4/3) &#8776; 28.77%</span>
    <span id="ws-status" class="status err" style="margin-left:0.75rem">disconnected</span>
  </div>
</header>
<main>
  <div class="koi-card">
    <div class="koi-balance" id="koi-bal"></div>
    <div class="koi-rate" id="koi-rate"></div>
  </div>

  <div class="wallets" id="wallets"></div>

  <div class="section">
    <h2>Transfer</h2>
    <div class="transfer-form">
      <div class="field">
        <label>From</label>
        <select id="sel-from"></select>
      </div>
      <div class="field">
        <label>To</label>
        <select id="sel-to"></select>
      </div>
      <div class="field">
        <label>Amount</label>
        <input type="number" id="inp-amount" min="0" step="any" placeholder="0.00">
      </div>
      <button class="btn" id="btn-send">Send</button>
    </div>
    <div id="error" class="error-msg"></div>
  </div>

  <div class="section">
    <h2>Transaction Log</h2>
    <div class="log-entries" id="log"></div>
  </div>
</main>

<script>
let state = null;
let tOff = 0;

function sNow() { return Date.now() / 1000 + tOff; }

function fmt(n) {
  if (n === 0) return '0.00';
  const a = Math.abs(n);
  if (a >= 1e12) return n.toLocaleString('en-US', {maximumFractionDigits: 0});
  if (a >= 1e6) return n.toLocaleString('en-US', {maximumFractionDigits: 2});
  if (a >= 1) return n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 6});
  return n.toLocaleString('en-US', {minimumFractionDigits: 6, maximumFractionDigits: 10});
}

function calcBal(w, t) {
  if (w.name === 'Koi') {
    let bal = w.balance;
    for (const p of w.pending) {
      const pdt = (t - p.t) / state.spy;
      bal += p.amount * (1 - Math.exp(-state.rate * pdt));
    }
    for (const o of state.wallets) {
      if (o.name === 'Koi') continue;
      const dt = (t - o.t) / state.spy;
      bal -= o.balance * (Math.exp(state.rate * dt) - 1);
    }
    return bal;
  }
  const dt = (t - w.t) / state.spy;
  let bal = w.balance * Math.exp(state.rate * dt);
  for (const p of w.pending) {
    const pdt = (t - p.t) / state.spy;
    bal += p.amount * (1 - Math.exp(-state.rate * pdt));
  }
  return bal;
}

function initCards() {
  const c = document.getElementById('wallets');
  c.innerHTML = '';
  const sf = document.getElementById('sel-from');
  const st = document.getElementById('sel-to');
  sf.innerHTML = '';
  st.innerHTML = '';
  for (const w of state.wallets) {
    // Koi goes in the top banner, not the grid
    if (w.name !== 'Koi') {
      const card = document.createElement('div');
      card.className = 'wallet-card';
      card.id = 'card-' + w.name;
      card.innerHTML =
        '<div class="name">' + w.name + '</div>' +
        '<div class="balance" id="bal-' + w.name + '"></div>' +
        '<div class="rate" id="rate-' + w.name + '"></div>' +
        '<div id="pnd-' + w.name + '"></div>';
      c.appendChild(card);
    }
    sf.add(new Option(w.name, w.name));
    st.add(new Option(w.name, w.name));
  }
  st.selectedIndex = 1;
}

function render() {
  if (!state) return;
  const t = sNow();

  // Koi banner
  const koi = state.wallets.find(function(w) { return w.name === 'Koi'; });
  if (koi) {
    const koiBal = calcBal(koi, t);
    document.getElementById('koi-bal').textContent = fmt(koiBal) + ' koi';
    let drain = 0;
    for (const o of state.wallets) {
      if (o.name === 'Koi') continue;
      const obal = calcBal(o, t);
      drain += obal * (Math.exp(state.rate / state.spy) - 1);
    }
    document.getElementById('koi-rate').textContent = '-' + fmt(drain) + '/sec';
  }

  // Regular wallets
  for (const w of state.wallets) {
    if (w.name === 'Koi') continue;
    const bal = calcBal(w, t);
    const perSec = bal * (Math.exp(state.rate / state.spy) - 1);
    const balEl = document.getElementById('bal-' + w.name);
    const rateEl = document.getElementById('rate-' + w.name);
    const pndEl = document.getElementById('pnd-' + w.name);
    if (!balEl) continue;
    balEl.textContent = fmt(bal) + ' koi';
    rateEl.textContent = '+' + fmt(perSec) + '/sec';

    let html = '';
    for (const p of w.pending) {
      const pdt = (t - p.t) / state.spy;
      const rem = p.amount * Math.exp(-state.rate * pdt);
      if (rem > 0.000001) {
        html += '<div class="pending-item">\u2190 ' + p.from + ': ' + fmt(rem) + ' koi</div>';
      }
    }
    pndEl.innerHTML = html ? '<div class="pending-label">Pending</div>' + html : '';
  }
}

function renderLog() {
  if (!state) return;
  const c = document.getElementById('log');
  c.innerHTML = '';
  const entries = state.log.slice().reverse();
  for (const e of entries) {
    const d = document.createElement('div');
    d.className = 'log-entry';
    const ago = fmtAgo(e.t);
    d.innerHTML =
      '<span class="detail">' + e.from + ' <span class="arrow">\u2192</span> ' +
      e.to + ': <span class="amount">' + fmt(e.amount) + '</span> koi</span>' +
      '<span class="time">' + ago + '</span>';
    c.appendChild(d);
  }
}

function fmtAgo(t) {
  const s = sNow() - t;
  if (s < 60) return Math.floor(s) + 's ago';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  return Math.floor(s / 86400) + 'd ago';
}

document.getElementById('btn-send').addEventListener('click', async function() {
  const from = document.getElementById('sel-from').value;
  const to = document.getElementById('sel-to').value;
  const amount = parseFloat(document.getElementById('inp-amount').value);
  const errEl = document.getElementById('error');
  errEl.textContent = '';

  if (!amount || amount <= 0) { errEl.textContent = 'Enter a valid amount'; return; }
  if (from === to) { errEl.textContent = 'Cannot send to self'; return; }

  this.disabled = true;
  try {
    const res = await fetch('/api/send', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({from, to, amount}),
    });
    const data = await res.json();
    if (!data.ok) {
      errEl.textContent = data.error || 'Transfer failed';
    } else {
      document.getElementById('inp-amount').value = '';
    }
  } catch (e) {
    errEl.textContent = 'Network error';
  }
  this.disabled = false;
});

let cardsInit = false;

function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const ws = new WebSocket(proto + '//' + location.host + '/ws');
  const st = document.getElementById('ws-status');

  ws.onopen = function() {
    st.textContent = 'connected';
    st.className = 'status ok';
  };

  ws.onmessage = function(e) {
    state = JSON.parse(e.data);
    tOff = state.t - Date.now() / 1000;
    if (!cardsInit) { initCards(); cardsInit = true; }
    renderLog();
  };

  ws.onclose = function() {
    st.textContent = 'disconnected';
    st.className = 'status err';
    cardsInit = false;
    setTimeout(connect, 1000);
  };

  ws.onerror = function() { ws.close(); };
}

connect();
setInterval(render, 1000);
setInterval(renderLog, 5000);
</script>
</body>
</html>
